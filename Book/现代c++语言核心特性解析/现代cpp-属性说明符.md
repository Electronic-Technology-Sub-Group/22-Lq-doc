# 属性方言

C++ 属性说明符类似 Java 源码级注解，是代码与编译器约定的一种途径。

早期 C++ 没有相关语法，GCC 和 MSVC 等主流编译器产生了各自的属性语法。注意这些语法不在标准 C++ 语法中。

GCC 2.9.3 开始支持属性说明，使用 GCC 扩展的关键字 `__attribute__` 加双层括号实现属性功能。

```c++
__attribute__((attribute-list))
```

MSVC 使用的是 `__declspec` 扩展关键字实现属性功能，但后面使用的是单层括号。

```c++
__declspec(attribute-list)
```
# C++ 标准属性说明

C++11 开始支持属性说明，使用双层方括号 `[[]]` 标记，主要有以下三种形式：

```c++
[[attr]]
[[attr1, attr2, attr3(arg)]]
[[namespace::attr(arg)]]
```

C++17 开始，允许使用 `using` 展开属性说明符的命名空间

```c++
[[using attribute-namespace : attribute-list]]
// 例如
[[using gnu: always_inline, hot, const]]
```

C++17 开始规定，编译器应当忽略无法识别的编译器属性。
# 标准属性

## `noreturn`

C++11 引入，约定函数不会返回。该属性仅用于函数。

与返回 `void` 不同的是，该属性作用于编译器生成字节码时，在执行该函数后直接中断，而不是返回并继续执行程序。

```c++
[[noreturn]]
void f() {
    cout << "f()\n";
}

int main() {
    cout << "before call f()\n";
    f();
    // 该语句不会被执行
    cout << "after call f()\n";
    return 0;
}
```

从字节码上看，编译以下代码：

```c++
void f() {
}

[[noreturn]]
void g() {
}

int main() {
    f();
    g();
    return 0;
}
```

![[clion64_20240214_47.png]]

左侧是 `g()` 不带 `[[noreturn]]` 的情况，右侧为带有该属性的编译结果。可以看到，右侧汇编代码中，`main` 函数调用 `g()` 的部分不再存在。
## `carries_dependency`

C++11 引入，允许跨函数传递内存依赖项，用于弱内存顺序架构平台上多线程程序优化，避免编译器生成不必要的内存栅栏命令。

该属性可用于：
1. 函数或 `lambda` 表达式参数属性，表示函数内部会处理好该问题，编译器可以不生成内存栅栏命令
2. 函数属性，表示函数返回值已经处理好内存顺序，不需要编译器在函数返回前插入内存栅栏命令

> [!note]
> 弱内存顺序架构：再多核心的情况下，一个核心看到的共享内存中值的变化与另一个核心写入它们的顺序不同，如 `PowerPC` 架构。`x86/64` 架构不属于弱内存顺序架构。

## `deprecated`

C++14 引入，表示被该属性修饰的成员（支持函数，变量，类，命名空间等所有类型）已被弃用，不推荐使用。

被改属性标记的成员仍可以被使用，但编译器会产生警告。该属性可以接受一个字符串作为警告内容。

```c++
[[deprecated("foo is deprecated!")]]
void foo() {}
```
## `fallthrough`

C++17 引入，修饰一个 `switch` 块，表示该块中 `fallthrough` 行为是有意设计的，不需要警告。
## `nodiscard`

C++17 引入，表示该函数的返回值不应当被丢弃。若调用了该函数但返回值没有被使用，编译器将给出警告。
- 修饰函数时，表示该函数返回值不应被忽略
- 修饰类或枚举时，表示返回该类型的函数返回值不应被忽略

该属性多用于：
- 返回指针时，提示后续使用者需要手动释放
- 工厂函数或影响运行流程的函数，重要的是结果而非函数本身

C++20 后，该属性支持接收一个字符串参数作为警告信息。

```c++
[[nodiscard("Memory Leak!")]]
void *foo() {}
```
## `maybe_unused`

C++17 引入，可修饰类型、变量、函数等，表示若该值（类型，变量，返回值）没有被使用，不需要给出警告。

该属性用于 GCC 带有 `-Wunused-parameter` 或 MSVC W4 级警告等特殊情况。
## `likely`，`unlikely`

C++20 引入，声明函数或语句。`likely` 允许编译器对该属性修饰的执行路径相对于其他执行路径进行优化，`unlikely` 相反。常用于 `switch` 块。
## `no_unique_address`

C++20 引入，修饰非位域非静态成员变量，表示该变量不需要唯一地址，即不需要与其他非静态成员使用不同地址。

该属性用于那种无状态类的成员（包括仿函数），该类成员对象不需要占用空间，只需要通过它可以访问到他们的函数即可。
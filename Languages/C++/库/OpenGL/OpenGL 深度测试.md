> [!note]- 深度测试
> 当启用深度测试时，OpenGL 将一个片段的深度值与深度缓冲的内容进行对比。如果这个测试通过了的话，深度缓冲将会更新为新的深度值。如果深度测试失败了，片段将会被丢弃。

> [!note]- 深度缓冲
> 即 Z-缓冲，由窗口系统自动创建。大部分的系统中，深度缓冲使用24位float储存深度值。（可能是16，24或32位）

深度测试在模板测试之后，视口剪裁之前执行（片元着色器之后）

> [!note]- 提前深度测试
> 允许深度测试在片元着色器之前执行，提前丢弃无法显示的片段。此时片元着色器无法重新写入深度值
# 深度 API

OpenGL 中与深度测试相关的常用 API 有：
- 启用或关闭测试，默认关闭

```c++
// 启用深度测试
glEnable(GL_DEPTH_TEST);
// 关闭深度测试
glDisable(GL_DEPTH_TEST);
```

- 清空深度缓冲区，每次绘制前调用，否则绘制结果会受上一次渲染影响

```c++
glClear(GL_DEPTH_BUFFER_BIT);
```

- 设置只读深度缓冲区，开启后深度缓冲区的值将无法改变

```c++
// false 标记为只读, true 标记可写
glDepthMask(false);
```

- 深度测试函数，控制 OpenGL 如何比较和丢弃片段，默认即 `GL_LESS`

```c++
glDepthFunc(GL_LESS);
```

| 深度测试函数          | 说明                                   |
| --------------------- | -------------------------------------- |
| GL_ALWAYS, GL_NEVER   | 测试总通过或不通过                     |
| GL_LESS, GL_GREATER   | 片段深度小于或大于深度值时通过         |
| GL_LEQUAL, GL_GEQUAL  | 片段深度小于等于或大于等于深度值时通过 |
| GL_EQUAL, GL_NOTEQUAL | 片段深度与缓冲区值相等或不等时通过     | 
# 深度值

OpenGL 深度值计算方法为：设近平面 z 值为 near，远平面为 far，片元 z 坐标为 z，则其深度值 $F_{depth}$ 并非直接使用线型深度缓冲，而是：
$$
\begin{equation} F_{depth} = \frac{1/z - 1/near}{1/far - 1/near} \end{equation}
$$
其曲线如下，在前期增长迅速，后期增长缓慢
![[Pasted image 20230912173034.png]]
深度值可以在片元着色器中通过 `gl_FragCoord.z` 访问到，因此可以通过此完成深度值的可视化。
# 深度冲突

当两个片段的深度缓冲值相同或没有足够的精度进行区分，会使两个片段的图形不断地切换前后顺序，导致奇怪的闪烁花纹现象出现。解决方法有：
- 不要把两个物品靠得太近，尤其是 z 轴太近
- 根据深度值的计算方法，近平面尽可能远一些
- 使用更高精度的深度缓冲，但会牺牲一些性能
- 使用 `glPolygonOffset` 为物品设置额外的 z 轴偏移量

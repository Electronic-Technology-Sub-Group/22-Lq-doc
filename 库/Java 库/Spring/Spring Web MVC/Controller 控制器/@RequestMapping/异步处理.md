# 异步处理

当 `@RequestMapping` 参数修饰的方法返回一个 `Callable` 或 `DeferredResult` 时，Spring 负责在一个应用程序线程（非 Servlet 线程）处理并返回其运算结果。

默认 Spring 开启异步请求处理。可以通过以下方法设置：  
`<servlet><async-support>true or false</async-support></servlet>`  
`AbstractAnnotationConfigDispatcherServletInitlizer#isAsyncSupport() -> true or false`

```java
@GetMapping(path = "/list_async")
public Callable<ModelAndView> listFixedDepositsAsync() {
    return () -> {
        Thread.sleep(5000);
        Map<String, Object> modelData = new HashMap<>();
        modelData.put("fdList", fixedDepositService.getFixedDeposits());
        return new ModelAndView("fixedDeposit/list", modelData);
    };
}
```

还可以返回 `DeferredResult<T>` 手动管理异步调用。`DeferredResult<T>` 表示一个异步调用的结果，通常放在一个容器中，使用任务或其他方式在一个单独的线程中执行。

```java
// 这是一个存储了异步上下文的对象
@Getter
public class ResultContext<T> {

    // 用于判断执行方法
    private final String methodToInvoke;
    private final Map<String, Object> params = new HashMap<>();
    // 用于存储执行结果
    private final DeferredResult<T> result = new DeferredResult<>();

    public ResultContext(String methodToInvoke) {
        this.methodToInvoke = methodToInvoke;
    }
}
```

`ResultContext<T>` 的 `setResult` 方法设置执行结果，使用 `setErrorResult` 设置异常信息，存在异常将交于 `handleException` 处理。

```java
private static final String LIST_METHOD = "getFixedDepositList";
private final Queue<ResultContext<?>> deferredResultQueue = new ConcurrentLinkedQueue<>();

@GetMapping(path = "/list2")
public DeferredResult<ResponseEntity<List<FixedDepositDetails>>> listFixedDeposits2() {
    ResultContext<ResponseEntity<List<FixedDepositDetails>>> context = new ResultContext<>(LIST_METHOD);
    deferredResultQueue.add(context);
    return context.getResult();
}

// 设置任务执行计划
@Scheduled(fixedRate = 1000)
public void processResults() {
    while (!deferredResultQueue.isEmpty()) {
        ResultContext<?> context = deferredResultQueue.poll();
        switch (context.getMethodToInvoke()) {
            case LIST_METHOD:
                var result = (DeferredResult<ResponseEntity<List<FixedDepositDetails>>>) context.getResult();
                List<FixedDepositDetails> fixedDeposits = fixedDepositService.getFixedDeposits();
                var response = new ResponseEntity<>(fixedDeposits, HttpStatus.OK);
                result.setResult(response);
                break;
            // ...
        }
    }
}
```

可使用 `<mvc:async-support default-timeout=xxx>` 设置超时时间，注解配置在 `WebMvcConfigurer#configureAsyncSupport` 中设置

```java
@Configuration
public class WebConfigurer implements WebMvcConfigurer {

    @Override
    public void configureAsyncSupport(AsyncSupportConfigurer configurer) {
        configurer.setDefaultTimeout(10000);
    }
}
```

# 发送电子邮件

Spring 提供 `JavaMail` 的包装类，简化发送电子邮件的过程。

依赖：`org.springframework.boot:spring-boot-starter-mail`，`jakarta.mail:jakarta.mail-api`

创建一个 `JavaMailSenderImpl` 类型的 `bean`，之后使用该 `bean` 发送邮件即可。

```xml
<bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
    <property name="host" value="${host}"/>
    <property name="protocol" value="${protocol}"/>
    <property name="port" value="${port}"/>
    <property name="username" value="${email}"/>
    <property name="password" value="${password}"/>
    <property name="javaMailProperties">
        <props>
            <prop key="mail.smtp.auth">true</prop>
            <prop key="mail.smtp.starttls.enable">true</prop>
        </props>
    </property>
</bean>
```

这里配合 JMS 发送邮件。

`requestReceivedTemplate` 为邮件模板，是一个 `org.springframework.mail.SimpleMailMessage` 对象。由于每次发送邮件内容相同，使用一个对象即可。

```java
@Autowired
private transient MailSender mallSender;

@Autowired
@Qualifier("requestReceivedTemplate")
private transient SimpleMailMessage simpleMailMessage;

@JmsListener(id = "emailMessageListener", destination = "emailQueueDestination")
public void onSendEmail(Message message) {
    TextMessage textMessage = (TextMessage) message;
    try {
        simpleMailMessage.setTo(textMessage.getText());
        mallSender.send(simpleMailMessage);
        System.out.println("Send email " + simpleMailMessage);
    } catch (JMSException e) {
        throw new RuntimeException(e);
    }
}
```

`SimpleMailMessage` 仅用于发送文本信息。`MIME` 消息可以使用 `MimeMessageHelper` 辅助创建，也可以通过 `MimeMessagePreparator` 组装。

```java
@JmsListener(id = "emailProcessedMessageListener", destination = "emailQueueDestination")
public void onSendProcessedEmail(Message message) {
    TextMessage textMessage = (TextMessage) message;
    try {
        String sendTo = textMessage.getText();
        MimeMessage mimeMessage = mailSender.createMimeMessage();
        MimeMessageHelper mimeMessageHelper = new MimeMessageHelper(mimeMessage);
        mimeMessageHelper.setTo(sendTo);
        mimeMessageHelper.setSubject(processedMailMessage.getSubject());
        mimeMessageHelper.setText(processedMailMessage.getText());
        mailSender.send(mimeMessage);
        System.out.println("Send email " + mimeMessage);
    } catch (JMSException | MessagingException e) {
        throw new RuntimeException(e);
    }
}
```

```java
// 使用 MimeMessagePreparator 组装
mailSender.send(mimeMessage -> {
    mimeMessage.setFrom(processedMailMessage.getFrom());
    // ...
});
```

‍

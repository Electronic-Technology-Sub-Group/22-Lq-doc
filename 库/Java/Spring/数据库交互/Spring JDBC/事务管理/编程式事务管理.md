# 编程式事务管理

Spring 通过 `TransactionTemplate` 以编程的形式管理事务，常用属性包括：

* `transactionManager`：持有一个 `PlatformTransactionManager` 实例
* `isolationLevel`：事务隔离级别

  |事务隔离级别|说明|
  | --------------| ------------------------------------|
  |`ISOLATION_READ_UNCOMMITTED`|事务未提交的更改可以由其他事务读取|
* `propagationBehavior`：事务传播行为

  |事务传播行为|说明|
  | --------------| ------------------------------------------------------------------------------------|
  |`PROPAGATION_REQUIRED`|若事务未调用方法，事务管理器启动新事务并执行；否则，事务管理器在同一事务中执行方法|

```xml
<bean id="transactionTemplate" class="org.springframework.transaction.support.TransactionTemplate">
    <property name="transactionManager" ref="txManager"/>
    <property name="isolationLevelName" value="ISOLATION_READ_UNCOMMITTED"/>
    <property name="propagationBehaviorName" value="PROPAGATION_REQUIRED"/>
</bean>
```

`TransactionTemplate#execute` 方法表示开启并执行一个事务，`TransactionCallback<T>` 的泛型 T 即返回值类型。当执行失败时 `TransactionTemplate` 会自动执行 `rollback` 操作（`TransactionStatus.setRollbackOnly()`）。

* 若无返回值，使用 `TransactionCallbackWithoutResult`，或 `executeWithoutResult` 方法

```java
private static final String SQL_INSERT_CUSTOMER_REGISTRATION =
        "insert into customer_registration_details(ACCOUNT_NUMBER, ADDRESS, CARD_NUMBER) " +
        "value (:account, :address, :number)";

@Autowired
private TransactionTemplate transactionTemplate;

@Autowired
private NamedParameterJdbcTemplate jdbcTemplate;

@Override
public void registerCustomer(CustomerRegistrationDetails customerRegistrationDetails) {
    transactionTemplate.executeWithoutResult(status -> {
        Map<String, Object> arguments = new HashMap<>();
        arguments.put("account", customerRegistrationDetails.getAccountNumber());
        arguments.put("address", customerRegistrationDetails.getAddress());
        arguments.put("number", customerRegistrationDetails.getCardNumber());
        jdbcTemplate.update(SQL_INSERT_CUSTOMER_REGISTRATION, arguments);
    });
}
```

当然，也可以直接使用 `PlatformTransactionManager` 执行事务，但需要手动提交事务和回滚操作。

# 异步任务调度

可以使用 String 的 `TaskExecutor`、`TaskSchedule` 或 `@Async`、`@Schedule` 注解调度异步方法

Spring 的 `TaskExecutor` 实现了 `Executor` 接口，并提供了一组内置的实现。

|TaskExecutor|执行方式|
| --------------| --------------------------|
|`ThreadPoolTaskExecutor`|使用线程池执行任务|
|`SyncTaskExecutor`|同步执行任务|
|`SimpleAsyncTaskExecutor`|异步执行每个新线程的任务|
|`WorkManagerTaskExecutor`|使用 `CommonJWorkManager` 管理异步任务|

使用注解开发时，需要使用 `@EnableScheduling` 注解

```xml
解注册中，使用 WebMvcConfigurer 配置：

<bean id="abortPolicy" class="java.util.concurrent.ThreadPoolExecutor$AbortPolicy"/>
<bean id="myTaskExecutor" class="org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor">
    <property name="corePoolSize" value="5" />
    <property name="maxPoolSize" value="10" />
    <property name="queueCapacity" value="15" />
    <property name="rejectedExecutionHandler" ref="abortPolicy" />
</bean>
```

其中，`rejectedExecutionHandler` 表示队列满时的任务拒绝策略，指向一个 `RejectedExecutionHandler` 接口的实现类。

使用 `TaskExecutor#execute(Runnable)` 执行一个异步任务。

> 可以使用 `<task:executor>` 元素简化构建：
>
> 内置 `rejection-policy` 包括 `ABORT`，`CALLER_RUNS`，`DISCARD_OLDEST`，`DISCARD`
>
> ```xml
> <?xml version="1.0" encoding="UTF-8"?>
> <beans ...
>        xmlns:task="http://www.springframework.org/schema/task"
>        xsi:schemaLocation="...
>                            http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd">
>
>     <task:executor id="myTaskExecutor" pool-size="5-10" queue-capacity="15" rejection-policy="ABORT" />
> </beans>
> ```

使用注解开发时，使用 `@Async` 注解一个方法，可以返回 `void` 或 `Future<T>`。返回 `Future<T>` 时，将返回值包装成一个 `AsyncResult` 对象即可。

`TaskScheduler` 接口是对 `Runnable` 任务的抽象，`Triggle` 指的是 `Runnable` 执行的时间。`TaskScheduler` 与 `Triggle` 相关联以调度 `Runnable` 的执行。

* 定时执行：`PeriodicTriggle`
* 通过 corn 表达式指定：`CornTriggle`

`ThreadPoolTaskScheduler` 是最常用的 `TaskScheduler`，内部使用 `ScheduleThreadPoolExecutor` 实现。使用 `<task:scheduler>` 配置。

```xml
<task:scheduler id="myTaskScheduler" pool-size="5" />
```

在 `bean` 中，可以只用 `<task:scheduled-tasks>` 创建一组定时任务

```xml
<task:scheduled-tasks scheduler="myTaskScheduler">
    <task:scheduled ref="job-bean" method="job-method" fixed-rate="500"/>
</task:scheduled-tasks>
```

使用注解开发时，使用 `@Scheduled` 注解一个方法，必须返回 `void` 且没有参数，且需要指定 `cron`、`fixedRate` 或 `fixedDelay` 之一。
